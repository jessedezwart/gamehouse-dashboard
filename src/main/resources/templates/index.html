<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Gamehouse IX (2025)</title>

    <!-- HTMX, Chart.js, Timeline, Bootstrap -->
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        canvas {
            width: 100% !important;
            height: auto !important;
        }

        #timelineChart>div {
            height: 100% !important;
            overflow: visible !important;
        }

        #timelineContainer {
            overflow-x: auto;
            overflow-y: visible;
        }
    </style>
</head>

<body class="bg-secondary text-light pt-3">

    <div class="container-fluid">
        <h1 class="text-center mb-3">Gamehouse IX (2025)</h1>

        <!-- First row -->
        <div class="row g-2 mb-2">
            <div class="col-lg-3">
                <div class="card bg-dark border-0 text-white h-100">
                    <div class="card-body p-3">
                        <h6 class="card-title">Live Game Sessions</h6>
                        <div id="game-table" hx-get="/games/table" hx-trigger="load, every 1s" hx-swap="innerHTML">
                            Loading...
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3">
                <div class="card bg-dark border-0 text-white h-100">
                    <div class="card-body p-3">
                        <h6 class="card-title">Most Played Games</h6>
                        <div id="leaderboard" hx-get="/games/leaderboard" hx-trigger="load, every 10s"
                            hx-swap="innerHTML">
                            Loading...
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card bg-dark border-0 text-white h-100">
                    <div class="card-body p-3">
                        <h6 class="card-title">Total Playtime per Game</h6>
                        <div class="mx-auto" style="max-width: 420px;">
                            <div class="ratio ratio-1x1">
                                <canvas id="pieChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Second row -->
        <div class="row g-2">
            <div class="col-lg-4">
                <div class="card bg-dark border-0 text-white h-100">
                    <div class="card-body p-3">
                        <h6 class="card-title">User Leaderboard</h6>
                        <div id="user-leaderboard" hx-get="/games/stats/user-leaderboard" hx-trigger="load, every 30s"
                            hx-swap="innerHTML">Loading...</div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card bg-dark border-0 text-white h-100">
                    <div class="card-body p-3">
                        <h6 class="card-title">Peak Concurrency</h6>
                        <div class="ratio ratio-21x9">
                            <canvas id="concurrencyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timeline -->
        <div class="row g-3 mt-3">
            <div class="col-12">
                <div class="card bg-dark border-0 text-white">
                    <div class="card-body p-3">
                        <h6 class="card-title">Session Timeline</h6>
                        <div id="visTimeline" style="height: 300px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pie chart script -->
    <script>
        async function loadPieChart() {
            const res = await fetch('/games/stats/game-distribution');
            const data = await res.json();
            const ctx = document.getElementById('pieChart').getContext('2d');

            const chart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1
                }
            });

            setInterval(async () => {
                const update = await fetch('/games/stats/game-distribution');
                const json = await update.json();
                chart.data.labels = Object.keys(json);
                chart.data.datasets[0].data = Object.values(json);
                chart.update();
            }, 30000);
        }

        loadPieChart();
    </script>

    <!-- Concurrency chart script -->
    <script>
        async function loadConcurrencyChart() {
            const res = await fetch('/games/stats/peak-concurrency');
            const data = await res.json();
            const labels = Object.keys(data);
            const values = Object.values(data);
            const ctx = document.getElementById('concurrencyChart').getContext('2d');

            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Players online',
                        data: values,
                        fill: true,
                        tension: 0.35
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: 0,
                            max: 10,
                            ticks: {
                                stepSize: 1,
                                color: '#ccc',
                                precision: 0
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#ccc'
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.05)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e0e0e0' // Light gray for readability on dark background
                            }
                        }
                    }
                }
            });

            setInterval(async () => {
                const update = await fetch('/games/stats/peak-concurrency');
                const json = await update.json();
                chart.data.labels = Object.keys(json);
                chart.data.datasets[0].data = Object.values(json);
                chart.update();
            }, 60000);
        }

        loadConcurrencyChart();
    </script>

    <!-- Timeline script -->
    <script>
        // singleton datasets and instance
        let timeline;
        const tlItems = new vis.DataSet();
        const tlGroups = new vis.DataSet();

        async function loadVisTimeline() {
            const res = await fetch('/games/stats/session-timeline');
            const sessions = await res.json();

            // groups: use username as stable id
            const groupDefs = [...new Set(sessions.map(s => s.username))]
                .map(u => ({ id: u, content: u }));
            tlGroups.update(groupDefs);
            const incomingGroupIds = new Set(groupDefs.map(g => g.id));
            tlGroups.getIds().forEach(id => { if (!incomingGroupIds.has(id)) tlGroups.remove(id); });

            // items: stable composite id
            const itemDefs = sessions.map(s => ({
                id: `${s.username}|${s.start}|${s.end}|${s.game}`,
                group: s.username,
                content: s.game,
                start: s.start,
                end: s.end
            }));
            tlItems.update(itemDefs);
            const incomingItemIds = new Set(itemDefs.map(i => i.id));
            tlItems.getIds().forEach(id => { if (!incomingItemIds.has(id)) tlItems.remove(id); });

            if (!timeline) {
                const container = document.getElementById('visTimeline');
                const options = {
                    stack: false,
                    horizontalScroll: true,
                    zoomKey: 'ctrlKey',
                    margin: { item: 8, axis: 5 },
                    orientation: { axis: 'bottom' },
                    height: '100%',
                    groupHeightMode: 'fixed'
                };
                timeline = new vis.Timeline(container, tlItems, tlGroups, options);
            }
        }

        loadVisTimeline();
        setInterval(loadVisTimeline, 30000);
    </script>



</body>

</html>